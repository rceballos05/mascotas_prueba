@using Radzen
@using Radzen.Blazor
@using SistemaVeterinario.Backend.Interfaces
@inject IEspecieRepository especieRepository
@inject EmpresaSeleccionadaNavigationData empresaData
@inject UserNavgationData userLoged
<div class="container">
    <div class="row">
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Datos de la Especie</h5>
                    <form id="speciesForm">

                        <div class="mb-3">
                            <label for="identifier" class="form-label">Identificador</label>
                            <input type="text" class="form-control" id="identifier" @bind-value="Especie.Id" disabled="disabled">
                        </div>
                        <div class="mb-3">
                            <label for="name" class="form-label">Nombre</label>
                            <input type="text" class="form-control" id="name" @bind-value="Especie.Nombre">
                        </div>
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary btn-sm" @onclick="AgregarEspecie">
                                <i class="fa fa-plus"></i> Agregar Registro
                            </button>
                            <button type="button" class="btn btn-danger btn-sm" id="deleteBtn" @onclick="EliminarEspecie">
                                <i class="fa fa-trash"></i> Eliminar Registro
                            </button>
                            <button type="button" class="btn btn-secondary btn-sm" id="clearBtn" @onclick="LimpiarForm">
                                <i class="fa fa-arrow-counterclockwise"></i> Limpiar Formulario
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Listado Especies</h5>
                    <div class="table-responsive">
                        <RadzenDataGrid Data="@especies" TItem="EspecieDto" AllowPaging="true" PageSize="5" ShowPagingSummary="true" AllowFiltering="false" AllowSorting="true" EmptyText="No hay registros para mostrar." >
                            <Columns>
                                <RadzenDataGridColumn TItem="EspecieDto" Property="Id" Title="Código" />
                                <RadzenDataGridColumn TItem="EspecieDto" Property="Nombre" Title="Nombre" />

                                <RadzenDataGridColumn TItem="EspecieDto" Title="Acción">
                                    <Template Context="data">
                                        <RadzenButton Icon="check_circle" Style="color: green;" ButtonStyle="ButtonStyle.Light" Click="()=> SeleccionarEspecie(data)" />
                                    </Template>
                                </RadzenDataGridColumn>
                            </Columns>
                        </RadzenDataGrid>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code{
    private List<EspecieDto> especies = new List<EspecieDto>();
    private EspecieDto Especie = new EspecieDto();
    protected override async Task OnInitializedAsync()
    {
        var id = await especieRepository.GetNumeroEspecie(userLoged.Token,empresaData.Prefijo);
        Console.WriteLine(id);
        id = id[0];
        int nuevo = Convert.ToInt32(id) + 1;
        Especie.Id = nuevo.ToString().PadLeft(3,'0');
        var esp = await especieRepository.GetEspecies(userLoged.Token,empresaData.Prefijo);
        if (esp != null)
        {
            if (esp.Count > 0)
            {
                especies = esp;
            }
        }

    }

    private async Task AgregarEspecie()
    {
        var result = await especieRepository.PostEspecie(userLoged.Token,empresaData.Prefijo, Especie);
        Console.WriteLine(result);
        if(result)
        {
            ActualizarData();
        }
    }
    private async Task ActualizarEspecie()
    {
        var result = await especieRepository.PutEspecie(userLoged.Token,empresaData.Prefijo, Especie);
        Console.WriteLine(result);
        if (result)
        {
            ActualizarData();
        }
    }
    private async Task EliminarEspecie()
    {
        var result = await especieRepository.DeleteEspecie(userLoged.Token,empresaData.Prefijo, Especie.Id);
        Console.WriteLine(result);
        if (result)
        {
            ActualizarData();
        }
    }
    private async Task SeleccionarEspecie(EspecieDto especie)
    {
        Especie = especie;
        StateHasChanged();
    }
    private async Task LimpiarForm()
    {
        Especie = new EspecieDto();
        var id = await especieRepository.GetNumeroEspecie(userLoged.Token,empresaData.Prefijo);
        Console.WriteLine(id);
        id = id[0];
        int nuevo = Convert.ToInt32(id) + 1;
        Especie.Id = nuevo.ToString().PadLeft(3, '0');
    }
    private async Task ActualizarData()
    {
        especies = new List<EspecieDto>();
        var esp = await especieRepository.GetEspecies(userLoged.Token,empresaData.Prefijo);
        if (esp != null)
        {
            if(esp.Count > 0)
            {
                especies = esp;
            }

        }
        await LimpiarForm();
    }
}